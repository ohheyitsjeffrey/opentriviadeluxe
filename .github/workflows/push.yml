name: Trivia CI
on: push
jobs:
  rake:
    name: "Rails CI"
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: "password"
        ports: ["5432:5432"]    
    steps:
      - uses: actions/checkout@v2
      - name: Build the Rails app
        run: docker build -t opentriviadeluxe:latest -t opentriviadeluxe:${GITHUB_SHA} api/
      - name: Make tmp and log writeable
        run: sudo chmod -R 775 ${GITHUB_WORKSPACE}/api/tmp ${GITHUB_WORKSPACE}/api/log
      - name: Sanity check 1
        run: docker run --rm -v `pwd`/api:/trivia opentriviadeluxe:latest -- ls -la
      - name: Sanity check 2
        run: docker run --rm -v `pwd`/api:/trivia opentriviadeluxe:latest -- ls -la tmp
      - name: Run Rails tests and Rubocop (linter)
        env:
          RAILS_ENV: test
          POSTGRES_HOST: localhost
        run: docker run --rm -v `pwd`/api:/trivia opentriviadeluxe:latest -- bin/rake
  